# 系统架构说明

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        客户端 (JavaFX)                       │
├─────────────────────────────────────────────────────────────┤
│  ┌────────────────┐  ┌────────────────┐  ┌───────────────┐ │
│  │  系统托盘界面  │  │  传输列表界面  │  │   设置界面    │ │
│  └────────────────┘  └────────────────┘  └───────────────┘ │
│           │                   │                   │         │
│  ┌────────▼───────────────────▼───────────────────▼───────┐ │
│  │              UI Controllers 层                         │ │
│  └────────────────────────────┬───────────────────────────┘ │
│                               │                             │
│  ┌────────────────────────────▼───────────────────────────┐ │
│  │              Service 服务层                            │ │
│  │  ┌──────────────────┐  ┌──────────────────┐          │ │
│  │  │FileListService   │  │FileDownloadService│          │ │
│  │  └──────────────────┘  └──────────────────┘          │ │
│  └────────────────────────────┬───────────────────────────┘ │
│                               │                             │
│  ┌────────────────────────────▼───────────────────────────┐ │
│  │         AppConfig 配置管理 + AppKey生成               │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────┬───────────────────────┬───────────────────┘
                  │                       │
          HTTP请求(8080)             TCP连接(9090)
                  │                       │
┌─────────────────▼───────────────────────▼───────────────────┐
│                        服务端                                │
├─────────────────────────────────────────────────────────────┤
│  ┌────────────────┐          ┌────────────────┐            │
│  │ HTTP Server    │          │  TCP Server    │            │
│  │  (文件列表)    │          │  (文件传输)    │            │
│  └────────┬───────┘          └────────┬───────┘            │
│           │                           │                     │
│  ┌────────▼───────────────────────────▼───────┐            │
│  │         AppKey 验证 + 文件管理              │            │
│  └────────────────────┬────────────────────────┘            │
│                       │                                     │
│  ┌────────────────────▼────────────────────────┐            │
│  │          共享文件目录 (./share)              │            │
│  └─────────────────────────────────────────────┘            │
└─────────────────────────────────────────────────────────────┘
```

## 数据流程

### 1. 初始化流程

```
客户端启动
    │
    ├─> 加载配置 (AppConfig)
    │   ├─> 生成/加载 AppKey
    │   └─> 读取服务器地址、下载路径等
    │
    ├─> 初始化系统托盘
    │   ├─> 创建托盘图标
    │   └─> 设置右键菜单
    │
    └─> 启动定时任务
        └─> 每5秒轮询文件列表
```

### 2. 文件列表获取流程

```
定时任务触发
    │
    ├─> FileListService.fetchFileList()
    │   │
    │   ├─> HTTP GET /api/files
    │   │   Header: X-App-Key: xxx
    │   │
    │   └─> 服务端处理
    │       │
    │       ├─> 验证 AppKey
    │       ├─> 扫描 share 目录
    │       └─> 返回文件列表 JSON
    │
    ├─> 收到文件列表
    │   │
    │   └─> 如果有新文件
    │       ├─> 打开传输列表窗口
    │       └─> 创建下载任务
    │
    └─> 开始下载
```

### 3. 文件下载流程 (支持断点续传)

```
创建 DownloadTask
    │
    ├─> 检查本地文件
    │   ├─> 如果存在 → 获取已下载大小
    │   └─> 如果不存在 → 从0开始
    │
    ├─> TCP连接服务器 (端口9090)
    │   │
    │   ├─> 发送: appKey|filePath|startPosition
    │   │
    │   └─> 服务端处理
    │       ├─> 验证 AppKey
    │       ├─> 检查文件存在性
    │       ├─> 验证起始位置
    │       ├─> 返回: OK
    │       └─> 从指定位置发送文件数据
    │
    ├─> 接收数据流
    │   │
    │   ├─> 写入本地文件 (RandomAccessFile)
    │   ├─> 更新下载进度
    │   ├─> 计算下载速度
    │   └─> 刷新UI显示
    │
    └─> 下载完成
        └─> 更新任务状态
```

## 关键技术点

### 1. AppKey 生成与验证

**客户端**:
```java
// 生成32字节随机密钥，Base64编码
byte[] keyBytes = new byte[32];
new SecureRandom().nextBytes(keyBytes);
String appKey = Base64.getEncoder().encodeToString(keyBytes);
```

**服务端**:
```java
// 简化实现: 首次连接自动注册
String appKey = request.getHeader("X-App-Key");
VALID_APP_KEYS.add(appKey);
```

### 2. 系统托盘实现

```java
// 使用Java AWT
SystemTray tray = SystemTray.getSystemTray();
TrayIcon trayIcon = new TrayIcon(image, "文件传输客户端", popupMenu);
tray.add(trayIcon);

// 双击事件
trayIcon.addMouseListener(new MouseAdapter() {
    public void mouseClicked(MouseEvent e) {
        if (e.getClickCount() == 2) {
            // 打开传输列表
        }
    }
});
```

### 3. 定时轮询

```java
Timer timer = new Timer(true);
timer.scheduleAtFixedRate(new TimerTask() {
    public void run() {
        List<FileInfo> files = fetchFileList();
        // 处理文件列表
    }
}, 1000, config.getPollInterval() * 1000L);
```

### 4. 断点续传核心代码

**客户端**:
```java
// 检查已下载大小
long downloadedSize = saveFile.exists() ? saveFile.length() : 0;

// 发送请求包含起始位置
String request = appKey + "|" + filePath + "|" + downloadedSize;
out.writeUTF(request);

// 从断点位置继续写入
RandomAccessFile raf = new RandomAccessFile(saveFile, "rw");
raf.seek(downloadedSize);
```

**服务端**:
```java
// 解析起始位置
long startPosition = Long.parseLong(parts[2]);

// 从指定位置读取
RandomAccessFile raf = new RandomAccessFile(file, "r");
raf.seek(startPosition);

// 发送剩余数据
byte[] buffer = new byte[8192];
while ((bytesRead = raf.read(buffer)) != -1) {
    out.write(buffer, 0, bytesRead);
}
```

### 5. JavaFX UI线程更新

```java
// 后台任务完成后更新UI
Platform.runLater(() -> {
    task.setStatus(Status.COMPLETED);
    tableView.refresh();
});
```

## 配置存储

### AppConfig 配置文件

**位置**: `~/.file-transfer-client/config.json`

**内容**:
```json
{
  "serverUrl": "http://localhost:8080",
  "downloadPath": "C:\\Users\\xxx\\Downloads",
  "pollInterval": 5
}
```

### AppKey 存储

**位置**: `~/.file-transfer-client/appkey.txt`

**内容**: Base64编码的密钥字符串

## 数据模型

### FileInfo (文件信息)

```java
{
  fileName: String,      // 文件名
  filePath: String,      // 相对路径
  fileSize: long,        // 文件大小(字节)
  checksum: String,      // 校验和
  timestamp: long        // 时间戳
}
```

### DownloadTask (下载任务)

```java
{
  fileName: String,         // 文件名
  filePath: String,         // 服务器路径
  fileSize: long,          // 总大小
  downloadedSize: long,    // 已下载
  progress: double,        // 进度(0-1)
  status: String,          // 状态
  speed: String,           // 速度
  savePath: String,        // 保存路径
  paused: boolean,         // 是否暂停
  cancelled: boolean       // 是否取消
}
```

## 协议说明

### HTTP API

**端点**: `GET /api/files`

**请求头**:
```
X-App-Key: <base64-encoded-key>
```

**响应**:
- 200: 返回文件列表 JSON
- 204: 无文件
- 401: AppKey无效

### TCP 协议

**请求格式** (UTF-8字符串):
```
<appKey>|<filePath>|<startPosition>
```

**响应格式**:
1. UTF-8字符串: "OK" 或 "ERROR: <message>"
2. 如果OK，后续为文件字节流

## 线程模型

```
Main Thread (JavaFX)
    │
    ├─> UI事件处理
    └─> Platform.runLater() 更新UI

Background Timer Thread
    │
    └─> 定时轮询文件列表

Download Thread Pool
    │
    ├─> Thread 1: 下载任务1
    ├─> Thread 2: 下载任务2
    └─> Thread n: 下载任务n

Server Thread Pool
    │
    ├─> HTTP Handler Threads
    └─> TCP Client Handler Threads
```

## 安全考虑

当前实现的安全特性:
- ✅ AppKey身份验证
- ✅ 配置文件本地存储
- ✅ TCP直连传输

生产环境建议增强:
- ⚠️ HTTPS加密传输
- ⚠️ AppKey数据库存储
- ⚠️ 文件完整性校验(MD5/SHA256)
- ⚠️ 传输加密(TLS/SSL)
- ⚠️ 访问日志审计

## 性能优化点

1. **缓冲区大小**: 默认8KB，可根据网络环境调整
2. **并发下载**: 当前单线程，可改为多线程分片下载
3. **连接池**: HTTP客户端使用连接池复用
4. **UI刷新频率**: 限制为1秒更新一次，避免过度刷新

---

**架构设计遵循分层原则，职责清晰，易于维护和扩展。**
