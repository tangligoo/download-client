name: Multi-Platform Build

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Build for ${{ matrix.os }} (${{ matrix.arch }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows
            arch: x64
            runner: windows-latest
          - os: linux
            arch: x64
            runner: ubuntu-latest
          - os: linux
            arch: arm64
            runner: ubuntu-24.04-arm # 公开仓库支持原生 ARM 节点

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'

    - name: Build with Maven
      shell: bash
      run: |
        mvn clean package -DskipTests
        # 创建一个干净的输入目录，避免重复打包
        mkdir -p target/input
        mvn dependency:copy-dependencies -DoutputDirectory=target/input -DincludeScope=runtime
        cp target/*.jar target/input/

    - name: Package (Windows)
      if: matrix.os == 'windows'
      shell: pwsh
      run: |
        jpackage --type app-image `
          --name "FileTransferClient" `
          --input target/input `
          --main-jar file-transfer-client-1.0.0.jar `
          --main-class com.qoder.client.Launcher `
          --dest target/dist `
          --vendor "Qoder" `
          --jlink-options "--strip-debug --no-man-pages --no-header-files --compress 2"

    - name: Package (Linux)
      if: matrix.os == 'linux'
      run: |
        jpackage --type app-image \
          --name "FileTransferClient" \
          --input target/input \
          --main-jar file-transfer-client-1.0.0.jar \
          --main-class com.qoder.client.Launcher \
          --dest target/dist \
          --vendor "Qoder" \
          --jlink-options "--strip-debug --no-man-pages --no-header-files --compress 2"

    - name: Archive Production (Windows)
      if: matrix.os == 'windows'
      shell: pwsh
      run: |
        cd target/dist
        Compress-Archive -Path FileTransferClient -DestinationPath ../../FileTransferClient-Windows-${{ matrix.arch }}.zip

    - name: Archive Production (Linux)
      if: matrix.os == 'linux'
      run: |
        cd target/dist
        zip -r ../../FileTransferClient-Linux-${{ matrix.arch }}.zip FileTransferClient

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: FileTransferClient-${{ matrix.os }}-${{ matrix.arch }}
        path: "*.zip"
